import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# --------------------------
# ë°ì´í„°: ë‚ ì§œë³„ ì°¸ì„ì ëª©ë¡
# --------------------------
attendance_by_date = {
    "7/28 (ì›”) ì‚¬ì£¼": ["í‚¤í‚¤ 90 ì„œìš¸", "ìœ¼ë‹ 92 ì„œìš¸", "ìƒê°• 93 ì„œìš¸", "íŠœë¸Œ 94 ê²½ê¸°", "ì´ë¶ˆ 91 ì„œìš¸", "ì„ ì„  88 ì„œìš¸"],
    "7/19 (í† ) ì¢…ë¡œë…¸í¬": ["íŠœë¸Œ 94 ê²½ê¸°", "ìœ¼ë‹ 92 ì„œìš¸", "ì•°ë²„ 86 ê²½ê¸°", "ë Œ 93 ê²½ê¸°", "í‚¤í‚¤ 90 ì„œìš¸", "ì´ë¶ˆ 91 ì„œìš¸", "ë¼ì´ 87 ì„œìš¸"],
    "7/12 (í† ) ì´ìì¹´ì•¼": ["ë Œ 93 ê²½ê¸°", "ì•°ë²„ 86 ê²½ê¸°"],
    "7/12 (í† ) ë¡ ë®¤ìµì „ì‹œ": ["ì„ ì„  88 ì„œìš¸", "ê¹Œì•… 90 ê²½ê¸°", "ìˆ˜ë„ 92 ì¸ì²œ"],
    "7/11 (ê¸ˆ) ë§ˆê³¡í”¼ì": ["ìˆ˜ë„ 92 ì¸ì²œ", "í‚¤í‚¤ 90 ì„œìš¸", "ìš°ë¡± 92 ì„œìš¸", "ê¹Œì•… 90 ê²½ê¸°", "ì´í‹€ 91 ê²½ê¸°", "ë‚˜ë¬¼ 92 ì„œìš¸", "íŠœë¸Œ 94 ê²½ê¸°"],
    "7/10 (ëª©) ì ì‹¬êº¼ê±°": ["ìˆ˜ë„ 92 ì¸ì²œ", "í¥ì¹˜ 96 ê²½ê¸°"],
    "7/6 (ì¼) ê³µí¬ì „ì‹œ": ["ë„¤ì˜¤ 92 ì„œìš¸", "ìš°ë¡± 92 ì„œìš¸", "ìœ¼ë‹ 92 ì„œìš¸", "ì´ë¶ˆ 91 ì„œìš¸", "ì•°ë²„ 86 ê²½ê¸°", "í‚¤í‚¤ 90 ì„œìš¸", "ë§ˆí‚¤ 96 ê²½ê¸°", "ë‚˜ë¬¼ 92 ì„œìš¸"],
    "7/5 (í† ) ê´€ì•…ì‚°ì¼ì¶œ": ["ê¹Œì•… 90 ê²½ê¸°", "ë Œ 93 ê²½ê¸°", "í™ì‹œ 94 ê²½ê¸°", "ë¶€ì—‰ 93 ê²½ê¸°"]
}

# --------------------------
# ë°ì´í„° ì „ì²˜ë¦¬
# --------------------------
records = []
for date, people in attendance_by_date.items():
    for person in people:
        if 'ì´ì´' not in person and 'ì½œë¼' not in person:
            records.append({"ëª¨ì„ë‚ ì§œ": date, "ì°¸ì„ì": person})

df = pd.DataFrame(records)
df["ì›”"] = df["ëª¨ì„ë‚ ì§œ"].str.extract(r"(\d+)/")[0] + "ì›”"

# --------------------------
# UI êµ¬ì„±
# --------------------------
st.title("ğŸ‰ 7ì›” ëª¨ì„ ì°¸ì„ì ê´€ë¦¬")

# 1ï¸âƒ£ ëª¨ì„ë³„ ì°¸ì„ì í‘œ ë³´ê¸° (í”¼ë²— í˜•íƒœ)
st.subheader("ğŸ“… ëª¨ì„ë³„ ì°¸ì„ì ëª©ë¡")
grouped = df.groupby("ëª¨ì„ë‚ ì§œ")["ì°¸ì„ì"].apply(lambda x: ", ".join(sorted(x))).reset_index()
st.dataframe(grouped, use_container_width=True)

# 2ï¸âƒ£ ì°¸ì„ìë³„ ì°¸ì„ íšŸìˆ˜
st.subheader("ğŸ“Š ì°¸ì„ìë³„ ì°¸ì„ íšŸìˆ˜ (í‘œ + ê·¸ë˜í”„)")
summary = df["ì°¸ì„ì"].value_counts().reset_index()
summary.columns = ["ì°¸ì„ì", "ì°¸ì„ íšŸìˆ˜"]
st.dataframe(summary)

# ê·¸ë˜í”„
fig, ax = plt.subplots(figsize=(8, 6))
ax.barh(summary["ì°¸ì„ì"], summary["ì°¸ì„ íšŸìˆ˜"], color="teal")
ax.set_xlabel("ì°¸ì„ íšŸìˆ˜")
ax.set_title("ì°¸ì„ìë³„ ì´ ì°¸ì„ íšŸìˆ˜")
ax.invert_yaxis()
st.pyplot(fig)

# 3ï¸âƒ£ ì°¸ì„ìë³„ ì›”ë³„ ê·¸ë˜í”„
st.subheader("ğŸ“ˆ ì°¸ì„ìë³„ ì›”ë³„ ì°¸ì„ í˜„í™©")
monthly = df.groupby(["ì›”", "ì°¸ì„ì"]).size().reset_index(name="íšŸìˆ˜")
pivot = monthly.pivot(index="ì°¸ì„ì", columns="ì›”", values="íšŸìˆ˜").fillna(0)
st.bar_chart(pivot)

# 4ï¸âƒ£ ê°œë³„ ì°¸ì„ì í•„í„°
st.subheader("ğŸ” íŠ¹ì • ì°¸ì„ì ë³´ê¸°")
name = st.selectbox("ì°¸ì„ì ì„ íƒ", sorted(df["ì°¸ì„ì"].unique()))
st.write(f"**{name}**ì˜ ì°¸ì„ ëª¨ì„:")
st.dataframe(df[df["ì°¸ì„ì"] == name][["ëª¨ì„ë‚ ì§œ"]])